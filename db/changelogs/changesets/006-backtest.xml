<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd">

    <changeSet id="006-backtest-create" author="nexus">
        <comment>Backtest run history and performance metrics.</comment>

        <createTable tableName="backtest_run">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="strategy_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_backtest_strategy"
                    references="strategy(id)"/>
            </column>
            <column name="model_id" type="INT">
                <constraints foreignKeyName="fk_backtest_model" references="model_registry(id)"/>
            </column>
            <column name="start_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="initial_capital" type="DECIMAL(18,4)">
                <constraints nullable="false"/>
            </column>
            <!-- Symbols traded (JSON array) -->
            <column name="symbol_list" type="JSON"/>
            <!-- Full config snapshot for reproducibility -->
            <column name="config" type="JSON"/>
            <!-- Performance metrics JSON: Sharpe, CAGR, max_drawdown, etc. -->
            <column name="metrics" type="JSON"/>
            <!-- Path to HTML/JSON report artifact -->
            <column name="report_path" type="VARCHAR(500)"/>
            <column name="status" type="ENUM('RUNNING','COMPLETED','FAILED')" defaultValue="RUNNING">
                <constraints nullable="false"/>
            </column>
            <column name="run_at" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="DATETIME"/>
        </createTable>

        <createIndex tableName="backtest_run" indexName="idx_backtest_strategy_run_at">
            <column name="strategy_id"/>
            <column name="run_at"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
